#!/usr/bin/env bash
#
# bashsupport disable=BP5004
# bashsupport disable=BP5007

#######################################
# No description.
# Globals:
#   HOME
# Arguments:
#   1 - command (required, string)
#######################################
this::completion_zsh() {
  local command
  command="${1:?}"
  case "${command}" in
    az)
      rm -f "${HOME:?}"/.local/share/zsh/site-functions/_az
      if [ -x "$(command -v az)" ]; then
        functions::stdout "creating '${HOME:?}/.local/share/zsh/site-functions/_az'..."
        {
          echo '#compdef az'
          curl --retry 5 -L -S -f -s https://raw.githubusercontent.com/Azure/azure-cli/refs/heads/main/az.completion
        } >> "${HOME:?}"/.local/share/zsh/site-functions/_az
      fi
      ;;
    git-completion.bash)
      rm -f "${HOME:?}"/.local/share/zsh/site-functions/git-completion.bash
      if [ -f /Library/Developer/CommandLineTools/usr/share/git-core/git-completion.bash ]; then
        functions::stdout "creating '${HOME:?}/.local/share/zsh/site-functions/git-completion.bash'..."
        ln -s /Library/Developer/CommandLineTools/usr/share/git-core/git-completion.bash \
          "${HOME:?}"/.local/share/zsh/site-functions/git-completion.bash
      fi
      ;;
    git-completion.zsh)
      rm -f "${HOME:?}"/.local/share/zsh/site-functions/git-completion.zsh
      if [ -f /Library/Developer/CommandLineTools/usr/share/git-core/git-completion.zsh ]; then
        functions::stdout "creating '${HOME:?}/.local/share/zsh/site-functions/git-completion.zsh'..."
        ln -s /Library/Developer/CommandLineTools/usr/share/git-core/git-completion.zsh \
          "${HOME:?}"/.local/share/zsh/site-functions/git-completion.zsh
      fi
      ;;
    pre-commit)
      rm -f "${HOME:?}"/.local/share/zsh/site-functions/_pre-commit
      if [ -x "$(command -v pre-commit)" ]; then
        functions::stdout "creating '${HOME:?}/.local/share/zsh/site-functions/_pre-commit'..."
        curl --retry 5 -L -S -f -o "${HOME:?}"/.local/share/zsh/site-functions/_pre-commit -s https://raw.githubusercontent.com/zsh-users/zsh-completions/refs/heads/master/src/_pre-commit
      fi
      ;;
    *)
      rm -f "${HOME:?}"/.local/share/zsh/site-functions/_"${command}"
      if [ -x "$(command -v "${command}")" ]; then
        functions::stdout "creating '${HOME:?}/.local/share/zsh/site-functions/_${command}'..."
        "${command}" completion zsh > "${HOME:?}"/.local/share/zsh/site-functions/_"${command}"
      fi
      ;;
  esac
}

#######################################
# No description.
# Arguments:
#   1 - exit code (optional, integer)
# Outputs:
#   Help message to stdout.
#######################################
this::help() {
  local exit_code
  exit_code="${1:-1}"
  cat << EOT

  Usage: $(basename "${0}") [OPTION...]

  Help options:
    -H Show this help message
    -U Display brief usage
    -V Print version

EOT
  functions::exit "${exit_code}"
}

#######################################
# No description.
# Globals:
#   HOME
#   OPTIND
# Arguments:
#   None
#######################################
main() {
  if [ -f "$(dirname "${0}")"/../etc/bash44.shconf ]; then
    # shellcheck source=../etc/bash44.shconf
    . "$(dirname "${0}")"/../etc/bash44.shconf || exit 1
  else
    # shellcheck source=/dev/null
    . "${HOME:?}"/.etc/bash44.shconf || exit 1
  fi

  if [ -f "$(dirname "${0}")"/../etc/constants.shconf ]; then
    # shellcheck source=../etc/constants.shconf
    . "$(dirname "${0}")"/../etc/constants.shconf
  else
    # shellcheck source=/dev/null
    . "${HOME:?}"/.etc/constants.shconf
  fi

  if [ -f "$(dirname "${0}")"/../etc/functions.shconf ]; then
    # shellcheck source=../etc/functions.shconf
    . "$(dirname "${0}")"/../etc/functions.shconf
  else
    # shellcheck source=/dev/null
    . "${HOME:?}"/.etc/functions.shconf
  fi

  local getopts_args
  local getopts_version
  getopts_args=''
  getopts_version='v20250730'

  trap 'functions::catch_all ${?}' ERR SIGHUP SIGINT SIGQUIT SIGTERM

  OPTIND=1
  while getopts 'HUV' getopts_args; do
    case "${getopts_args}" in
      H | U)
        this::help 0
        ;;
      V)
        functions::exit 0 "${getopts_version}"
        ;;
      ?)
        this::help 1
        ;;
    esac
  done
  shift $((OPTIND - 1))

  mkdir -p "${HOME:?}"/.local/share/zsh/site-functions

  this::completion_zsh az
  this::completion_zsh docker
  this::completion_zsh git-completion.bash
  this::completion_zsh git-completion.zsh
  this::completion_zsh helm
  this::completion_zsh kubectl
  this::completion_zsh kustomize
  this::completion_zsh oc
  this::completion_zsh op
  this::completion_zsh orbctl
  this::completion_zsh pre-commit
  this::completion_zsh rdctl
  this::completion_zsh yq
}

# bashsupport disable=BP5001
if [[ ${BASH_SOURCE[0]} == "${0}" ]]; then
  main "${@}"
fi
